---
  - name: Ansible Playbook
    hosts: all
    become: true
    pre_tasks:
      - name: Update cache 
        apt:
          update_cache: yes

      - name: install some plugin
        apt: 
         name: ['apt-transport-https', 'ca-certificates', 'curl', 'gnupg2']
         state: present
         update_cache: yes
    tasks:
  
      - name: disable swapping
        shell: swapoff -a

      - name: kernel modules 1
        shell: modprobe overlay
        
      - name: kernel modules 2
        shell: modprobe br_netfilter

      - name: kernel modules K8s
        shell:   cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
                 overlay
                 br_netfilter
                 EOF

      - name: IPtables setup 
        shell:    cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
                  net.bridge.bridge-nf-call-iptables  = 1
                  net.bridge.bridge-nf-call-ip6tables = 1
                  net.ipv4.ip_forward                 = 1
                  EOF   

      - name: Load the system 
        shell: sysctl --system  

      - name: presetup containerd
        copy:
          content: ""
          dest: /etc/modules-load.d/containerd.conf 
          force: no
          group: root
          owner: root
          mode: 0644  

      - name: Setup kernel modules (containerd)
        lineinfile:
          dest: /etc/modules-load.d/containerd.conf
          regexp: "{{ item.regexp }}"
          line: "{{ item.line }}"
        with_items:
        - { regexp: 'overlay', line: 'overlay' }
        - { regexp: 'br_netfilter', line: 'br_netfilter' }      


      